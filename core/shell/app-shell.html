<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../modules/app-router/app-router.html">
<link rel="import" href="../permissions/permissions.html">

<dom-module id="app-shell">
  <template>

    <app-router>
    </app-router>
  </template>
  <script>
    (() => {
      window.Project = window.Project || {}
      window.Project.Mixins = window.Project.Mixins || {}
      class AppShell extends ((typeof window.Project.Mixins.Permissions === 'function') ? window.Project.Mixins.Permissions(Polymer.Element) : Polymer.Element) {
        static get is () { return 'app-shell' }

        static get properties () {
          return Object.assign({}, super.properties, {

          })
        }

        constructor () {
          super()
          Object.defineProperty(this, '__routes', { value: JSON.parse(window.Project.__routes) })
          Object.freeze(this.__routes)
        }

        connectedCallback () {
          super.connectedCallback()
          var routes = this.__routes
          const router = this.shadowRoot.querySelector('app-router')
          this.__setRoutes(router, routes)
        }
        
        __setRoutes (router, routes, parentRoute, auth) {
          for (var i in routes) {
            if (!routes[i].node) {
              var node = document.createElement(routes[i])
              node.setAttribute('route', i)
              router.appendChild(node)
            } else {
              var node = document.createElement(routes[i].node)
              var route = parentRoute ? parentRoute + i : i
              auth = routes[i].auth ? routes[i].auth : auth
              node.setAttribute('route', route)
              if (auth && this[auth]) {
                node.addEventListener('check-auth', () => {
                  router.authenticate(this[auth].bind(this))
                })
                node.setAttribute('auth', '')
              }
              router.appendChild(node)
              
              if (routes[i].subroutes) {
                this.__setRoutes(router, routes[i].subroutes, route, auth)
              }
            }
            
          }
        }
      }

      window.customElements.define(AppShell.is, AppShell)
    })()
  </script>
</dom-module>
