<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../modules/app-router/app-router.html">
<link rel="import" href="../modules/app-network-status/app-network-status.html">
<link rel="import" href="../opts/auth-functions.html">
<link rel="import" href="../opts/firebase.html">

<dom-module id="app-shell">
  <template>

    <app-router>
    </app-router>
  </template>
  <script>
    (() => {
      class AppShell extends ((typeof window.Project.Mixins.Permissions === 'function') ? window.Project.Mixins.Permissions(window.Project.Mixins.AppNetworkStatus(Polymer.Element)) : window.Project.Mixins.AppNetworkStatus(Polymer.Element)) {
        static get is () { return 'app-shell' }

        static get properties () {
          return Project.__utils.__extends({}, super.properties, {})
        }

        constructor () {
          super()
          // if (performance) {
          //   console.log('App shell constructor called: ' + (performance.now() - window.globalStart))
          // }
          Object.defineProperty(this, '__routes', { value: JSON.parse(window.Project.__routes) })
          Object.defineProperty(this, '__shellComponents', { value: JSON.parse(window.Project.__shellComponents) })
          Object.freeze(this.__routes)
          Object.freeze(this.__shellComponents)
        }

        connectedCallback () {
          super.connectedCallback()
          const router = this.shadowRoot.querySelector('app-router')
          this.__setRoutes(router, this.__routes)
          this.__setComponents(router, this.__shellComponents)
        }

        __setRoutes (router, routes, parentRoute, auth) {
          for (var i in routes) {
            var node = document.createElement(routes[i].node ? routes[i].node : routes[i])
            var route = parentRoute ? parentRoute + i : i
            auth = routes[i].auth ? routes[i].auth : auth
            node.setAttribute('route', route)
            if (auth && this[auth]) {
              node.addEventListener('check-auth', () => {
                router.authenticate(this[auth].bind(this))
              })
              node.setAttribute('auth', '')
            }
            router.appendChild(node)

            if (routes[i].subroutes) {
              this.__setRoutes(router, routes[i].subroutes, route, auth)
            }
          }
        }

        __setComponents (content, components) {
          var componentsArray = []
          for (var i in components) {
            componentsArray.push(Project.__utils.__extends({}, components[i], { node: i }))
          }
          componentsArray.sort((p, q) => (p['.order'] - q['.order']))
          for (var j in componentsArray) {
            var node = document.createElement(componentsArray[j].node)
            for (var k in componentsArray[j]) {
              if (k !== 'node' && k !== '.order') {
                var attr = k === 'className' ? 'class' : k
                node.setAttribute(attr, componentsArray[j][k])
              }
            }
            content.parentNode.insertBefore(node, content)
          }
        }
      }

      window.customElements.define(AppShell.is, AppShell)
    })()
  </script>
</dom-module>
